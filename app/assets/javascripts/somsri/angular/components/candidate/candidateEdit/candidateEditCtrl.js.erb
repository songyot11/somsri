(function() {
  'use strict';
  angular.module('somsri.somsri.candidateEdit', [])
  .controller('candidateEditCtrl', ['$scope', '$rootScope', 'candidateEditService', '$state', function($scope, $rootScope, candidateEditService, $state) {
    var ctrl = this;
    var imagefile;
    ctrl.points = Array.from(Array(21).keys())

    $rootScope.loadAndAuthorizeResource("candidateEdit", function(){
      candidateEditService.getCandidate($state.params.id).then(function(resp) {
        ctrl.datas = resp;
      });

    ctrl.submit = function(params){
      ctrl.cannotUpdate = true;
      candidateEditService.saveCandidate(ctrl.datas.candidate.id, params).then(function(resp){
        window.location.reload()
      });
    };
    
    ctrl.showImage = function(event, id){
      var img = URL.createObjectURL(event.target.files[0]);
      $('#' + id).attr('src', img);
      ctrl.datas.candidate.image = event.target.files[0];
    }

    ctrl.addFile = function(){
      ctrl.datas.candidate.candidate_files_attributes.push({ files_file_name: "" });
    }

    ctrl.onFileChange = function(index, event){
      ctrl.datas.candidate.candidate_files_attributes[index].files = event.target.files[0]
    }

    ctrl.removeCandidateFiles = function(index) {
      if (ctrl.datas.candidate.candidate_files_attributes[index].files) {
        ctrl.datas.candidate.candidate_files_attributes.splice(index, 1);
      } else {
        ctrl.datas.candidate.candidate_files_attributes[index]._destroy = true
      }
    }

    ctrl.removeCandidateProgrammingSkill = function(index) {
      ctrl.datas.candidate.programming_skills_attributes[index]._destroy = true
    }

    ctrl.removeCandidateSoftSkill = function(index) {
      ctrl.datas.candidate.soft_skills_attributes[index]._destroy = true
    }

    ctrl.removeCandidateDesignSkill = function(index) {
      ctrl.datas.candidate.design_skills_attributes[index]._destroy = true
    }

    ctrl.addProgrammingskill = function(){
      ctrl.datas.candidate.programming_skills_attributes.push({ skill_name: "", skill_point: 0 });
    }

    ctrl.addSoftskill = function(){
      ctrl.datas.candidate.soft_skills_attributes.push({ skill_name: "", skill_point: 0 });
    }

    ctrl.addDesignskill = function(){
      ctrl.datas.candidate.design_skills_attributes.push({ skill_name: "", skill_point: 0 });
    }

    ctrl.isNotBlank = function(){
      var candidate = ctrl.datas.candidate
      if ((candidate.full_name || candidate.nick_name) && (candidate.email || candidate.phone) && candidate.school_year && candidate.from){
        ctrl.cannotUpdate = false;
      } else {
        ctrl.cannotUpdate = true;
      }
    } 
      });
    }]);
})();
